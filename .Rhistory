library(pacman)
p_load(rio, # Import/export data.
tidyverse, # Tidy-data.
stargazer, # Descriptive statistics.
gt, # Descriptive statistics.
gtsummary,
caret, # For predictive model assessment.
gridExtra, # Arrange plots.
skimr # Summarize data.
)
db <- import("https://github.com/ignaciomsarmiento/datasets/blob/main/GEIH_sample1.Rds?raw=true")
db <- as_tibble(db) |>
rename(bin_male = sex)
library(pacman)
p_load(rio, # Import/export data.
tidyverse, # Tidy-data.
stargazer, # Descriptive statistics.
gt, # Descriptive statistics.
gtsummary,
caret, # For predictive model assessment.
gridExtra, # Arrange plots.
skimr # Summarize data.
)
db <- import("https://github.com/ignaciomsarmiento/datasets/blob/main/GEIH_sample1.Rds?raw=true")
db <- as_tibble(db) |>
rename(bin_male = sex)
# Binary variable equal to one (1) if the person is a minor, and zero (0)
# otherwise.
db <- db |>
mutate(bin_minor = ifelse(test = age <= 6, yes = 1, no = 0))
# Total number of children per household.
db <- db |>
group_by(directorio, secuencia_p) |>
mutate(num_minors = sum(bin_minor, na.rm = TRUE)) |>
select(-bin_minor) |>
ungroup()
db  |> select(directorio, secuencia_p, age, num_minors) |> tail()
install.packages('IRkernel')
IRkernel::installspec(user = TRUE)
library(data.table)
data <- fread("C:/Users/lveras/OneDrive - FLAR/Work/Actividades/Geoconomic Fragmentation/Data/Non Tariff Measures/NTMs_HS2012ver_Researcher.csv", nrows = 100000)
View(data)
library(R.utils)
n <- countLines("C:/Users/lveras/OneDrive - FLAR/Work/Actividades/Geoconomic Fragmentation/Data/Non Tariff Measures/NTMs_HS2012ver_Researcher.csv")
data <- fread("C:/Users/lveras/OneDrive - FLAR/Work/Actividades/Geoconomic Fragmentation/Data/Non Tariff Measures/NTMs_HS2012ver_Researcher.csv", nrows = 1000000)
View(data)
require("pacman")
#Cargamos sf que será la librería a utilizar y tidyverse para nuestras necesidades de manejo de datos.
p_load(sf, tidyverse)
require("pacman")
#Cargamos sf que será la librería a utilizar y tidyverse para nuestras necesidades de manejo de datos.
p_load(sf, tidyverse)
colegios <- read_sf("https://raw.githubusercontent.com/ignaciomsarmiento/datasets/1585e2fef4eb7189af500f52a1022073d3ab0de0/colegios_bogota.json")
class(colegios)
View(colegios)
ggplot()+
geom_sf(data=colegios)
ggplot()+
geom_sf(data=colegios) +
theme_bw()
ciclovias <- st_read("C:/Users/lveras/Downloads/Ciclovia")
require("pacman")
#Cargamos sf que será la librería a utilizar y tidyverse para nuestras necesidades de manejo de datos.
p_load(sf, tidyverse)
colegios <- read_sf("https://raw.githubusercontent.com/ignaciomsarmiento/datasets/1585e2fef4eb7189af500f52a1022073d3ab0de0/colegios_bogota.json")
ggplot()+
geom_sf(data=colegios)
ggplot()+
geom_sf(data=colegios) +
theme_bw()
ciclovias <- st_read("C:/Users/lveras/Downloads/Ciclovia")
ggplot()+
geom_sf(data=ciclovias) +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
upl <- st_read("C:/Users/lveras/Downloads/upl")
ggplot()+
geom_sf(data=upla) +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
ggplot()+
geom_sf(data=upl) +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
head(upl)
ggplot()+
geom_sf(data=upla, aes(fill = Shape_Area)) +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
ggplot()+
geom_sf(data=upl, aes(fill = Shape_Area)) +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
ggplot()+
geom_sf(data=upl %>% filter(grepl("RIO",UPlNombre)==FALSE),size=.3,fill=NA) + #filtramos usando expresiones regulares
geom_sf(data=colegios[1:250,],shape=18) + #utilizamos solo los primeros 250 colegios y los representamos con romboides (shape=18)
geom_sf(data=ciclovias,col="red") +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
ggplot()+
geom_sf(data=upl %>% filter(grepl("RIO",Shape_Name)==FALSE),size=.3,fill=NA) + #filtramos usando expresiones regulares
geom_sf(data=colegios[1:250,],shape=18) + #utilizamos solo los primeros 250 colegios y los representamos con romboides (shape=18)
geom_sf(data=ciclovias,col="red") +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
head(ipl)
head(upl)
ggplot()+
geom_sf(data=upl %>% filter(grepl("RIO",NOMBRE)==FALSE),size=.3,fill=NA) + #filtramos usando expresiones regulares
geom_sf(data=colegios[1:250,],shape=18) + #utilizamos solo los primeros 250 colegios y los representamos con romboides (shape=18)
geom_sf(data=ciclovias,col="red") +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
View(upl)
ggplot()+
geom_sf(data=upl %>% filter(grepl("TORCA",NOMBRE)==FALSE),size=.3,fill=NA) + #filtramos usando expresiones regulares
geom_sf(data=colegios[1:250,],shape=18) + #utilizamos solo los primeros 250 colegios y los representamos con romboides (shape=18)
geom_sf(data=ciclovias,col="red") +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
ggplot()+
geom_sf(data=upl %>% filter(grepl("TORCA",NOMBRE)==FALSE),size=.3,fill=NA) + #filtramos usando expresiones regulares
geom_sf(data=colegios[1:250,],shape=18) + #utilizamos solo los primeros 250 colegios y los representamos con romboides (shape=18)
geom_sf(data=ciclovias,col="red") +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
head(upl)
ggplot()+
geom_sf(data=upl %>% filter(NOMBRE != "Puente Aranda"),size=.3,fill=NA) + #filtramos usando expresiones regulares
geom_sf(data=colegios[1:250,],shape=18) + #utilizamos solo los primeros 250 colegios y los representamos con romboides (shape=18)
geom_sf(data=ciclovias,col="red") +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
View(upl)
ggplot()+
geom_sf(data=upl %>% filter(NOMBRE != "Sumapáz"),size=.3,fill=NA) + #filtramos usando expresiones regulares
geom_sf(data=colegios[1:250,],shape=18) + #utilizamos solo los primeros 250 colegios y los representamos con romboides (shape=18)
geom_sf(data=ciclovias,col="red") +
theme_bw() +
theme(axis.title =element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(size=6))
setwd(dirname(dirname(rstudioapi::getActiveDocumentContext()$path)))
library(tidyverse)
data_united <- read.csv("stores/datos_unides.csv")
data_train <- read.csv("stores/train.csv")
data_test <- read.csv("stores/test.csv")
View(data_united)
View(data_united)
setwd(dirname(dirname(rstudioapi::getActiveDocumentContext()$path)))
library(tidyverse)
data_united <- readRDS("stores/datos_unides.rds")
setwd(dirname(dirname(rstudioapi::getActiveDocumentContext()$path)))
library(tidyverse)
data_united <- readRDS("stores/datos_unidos.rds")
View(data_united)
View(data_united)
View(data_united)
View(data_united)
View(data_united)
View(data_united)
View(data_united)
View(data_united)
View(data_train)
View(data_united)
setwd(dirname(dirname(rstudioapi::getActiveDocumentContext()$path)))
library(tidyverse)
data_united <- read.csv("stores/datos_unides.csv")
View(data_united)
#### ============================================================
### Punto 3 - Construcción de variables espaciales
#### ============================================================
# === Establecer el directorio de trabajo ===
setwd(dirname(dirname(rstudioapi::getActiveDocumentContext()$path)))
## 0) Paquetes y opciones generales -------------------------------------------
if (!requireNamespace("pacman", quietly = TRUE)) {
install.packages("pacman")
}
pacman::p_load(
tidyverse,
stringi,
rio,
leaflet,
here,
osmdata,
sf,
lwgeom,
doParallel,
foreach,
httr2,
curl
)
# Se desactiva s2 para evitar problemas en joins espaciales
sf::sf_use_s2(FALSE)
#### ============================================================
### 1) Funciones auxiliares
#### ============================================================
## 1.1) Función para extraer datos desde OpenStreetMap -------------------------
obtener_osmdata <- function(llave, valor, tipo_dato) {
# Se arma la consulta para el bounding box de Bogotá
consulta_osm <- osmdata::opq(bbox = osmdata::getbb("Bogotá Colombia")) |>
osmdata::add_osm_feature(key = llave, value = valor)
# Se descarga el objeto completo en formato sf
objeto_sf <- osmdata::osmdata_sf(consulta_osm)
# Según el tipo de geometría, se escoge la capa correspondiente
sf_filtrado <- dplyr::case_when(
tipo_dato == "linea"   ~ objeto_sf$osm_lines,
tipo_dato == "puntos"  ~ objeto_sf$osm_points,
tipo_dato == "poligono" ~ objeto_sf$osm_polygons,
TRUE                   ~ stop("tipo_dato debe ser 'linea', 'puntos' o 'poligono'")
) |>
dplyr::select(osm_id, name) |>
sf::st_as_sf(crs = 4326) |>
sf::st_transform(crs = 4326) |>
sf::st_make_valid()
return(sf_filtrado)
}
## 1.2) Distancia mínima a un conjunto de features -----------------------------
distneastfeat <- function(data_original, data_feat, n_variable, tipo_dato) {
# Si los features son polígonos, se trabaja con sus centroides
if (identical(tipo_dato, "poligono")) {
data_feat <- sf::st_centroid(data_feat, byid = TRUE)
}
# Matriz de distancias entre cada punto de data_original y cada feature
matriz_dist <- sf::st_distance(x = data_original, y = data_feat)
# Se toma la distancia mínima por observación
dist_min   <- apply(matriz_dist, 1L, min)
data_original[[n_variable]] <- dist_min
return(data_original)
}
## 1.3) Distancia mínima punto-a-conjunto (loop fila a fila) -------------------
distminpoints <- function(data_original, ext_points) {
n_obs   <- nrow(data_original)
dist_min <- vector(mode = "numeric", length = n_obs)
for (i in seq_len(n_obs)) {
dist_vec    <- sf::st_distance(data_original[i, ], ext_points)
dist_min[i] <- min(dist_vec)
}
return(dist_min)
}
#### ============================================================
### 2) Datos base de apartamentos
#### ============================================================
## 2.1) Lectura de train y test, y construcción de objeto sf -------------------
train_texto <- readRDS("stores/train_texto.rds")
test_texto  <- readRDS("stores/test_texto.rds")
datos <- bind_rows(test_texto, train_texto)
# Se convierten las coordenadas lon/lat a objeto espacial
datos <- sf::st_as_sf(
datos,
coords = c("lon", "lat"),
crs    = 4326
)
#### ============================================================
### 3) Geografía de Bogotá: localidades y sectores
#### ============================================================
## 3.1) Localidades ------------------------------------------------------------
localidades <- sf::st_read("stores/Localidad/Loca.shp", quiet = TRUE) |>
dplyr::select(LocNombre) |>
sf::st_transform(crs = 4326)
datos <- sf::st_join(datos, localidades, join = sf::st_within)
## 3.2) Sectores ---------------------------------------------------------------
sector <- sf::st_read("stores/Sector/SECTOR1.shp", quiet = TRUE) |>
sf::st_transform(crs = 4326) |>
dplyr::select(SCANOMBRE) |>
sf::st_make_valid()
datos <- sf::st_join(datos, sector, join = sf::st_within)
#### ============================================================
### 4) Datos abiertos de Bogotá
#### ============================================================
## 4.1) Lectura de shapefiles temáticos ---------------------------------------
indicador_loc    <- sf::st_read("stores/Indicador Localidad/IndLocalidad.shp", quiet = TRUE)
indicador_upz    <- sf::st_read("stores/Indicador UPZ/IndUPZ.shp", quiet = TRUE)
luminarias_upz   <- sf::st_read("stores/Luminaria/Luminarias_UPZ.shp", quiet = TRUE)
seguridad_nocturna <- sf::st_read("stores/Seguridad Nocturna/PuntosSeguridadNocturna.shp", quiet = TRUE)
bibliotecas      <- sf::st_read("stores/Bibliotecas/RedBibliotecAcademica.shp", quiet = TRUE)
museo            <- sf::st_read("stores/Museos/Museo.shp", quiet = TRUE)
colegios         <- sf::st_read("stores/Colegios/colegios06_2025.shp", quiet = TRUE)
recaudo_predial  <- sf::st_read("stores/Recaudo Predial/RPREDIAL.shp", quiet = TRUE)
manzanas_estr    <- sf::st_read("stores/Estratificacion/ManzanaEstratificacion.shp", quiet = TRUE)
sitp             <- sf::st_read("stores/SITP/PSITP.shp", quiet = TRUE)
delitos          <- sf::st_read("stores/Delitos/DAILoc.shp", quiet = TRUE)
restbar          <- sf::st_read("stores/Bares/EGBa.shp", quiet = TRUE)
## 4.2) Corrección de CRS y coordenadas de colegios ---------------------------
cat("Ajustando coordenadas y CRS de COLEGIOS...\n")
coords_col  <- sf::st_coordinates(colegios)
mascara_ok <- coords_col[, "X"] > -80 & coords_col[, "X"] < -70 &
coords_col[, "Y"] >   3 & coords_col[, "Y"] <   6
colegios <- colegios[mascara_ok, , drop = FALSE]
sf::st_crs(colegios) <- 4326
cat("Bounding box corregido de colegios:\n")
print(sf::st_bbox(colegios))
## 4.3) Estaciones de Transmilenio (WFS) --------------------------------------
transmi_raw <- sf::st_read(
"https://gis.transmilenio.gov.co/arcgis/services/Troncal/consulta_estaciones_troncales/MapServer/WFSServer?request=GetCapabilities&service=WFS",
quiet = TRUE
)
transmi <- transmi_raw |>
as.data.frame() |>
dplyr::select(-Shape) |>
sf::st_as_sf(coords = c("LONGITUD", "LATITUD"), crs = 4326) |>
sf::st_make_valid()
## 4.4) Homogeneización de CRS a 4326 -----------------------------------------
lista_capas <- c(
"colegios", "indicador_loc", "indicador_upz", "luminarias_upz",
"seguridad_nocturna", "bibliotecas", "museo", "recaudo_predial",
"manzanas_estr", "sitp", "delitos", "restbar"
)
for (nm in lista_capas) {
cat("Transformando CRS (si aplica) para:", nm, "...\n")
capa <- get(nm)
epsg_actual <- try(sf::st_crs(capa)$epsg, silent = TRUE)
if (!inherits(epsg_actual, "try-error") && !is.na(epsg_actual) && epsg_actual != 4326) {
capa <- sf::st_transform(capa, crs = 4326)
}
assign(nm, capa)
}
#### ============================================================
### 5) Unión de capas y construcción de variables espaciales
#### ============================================================
## 5.1) Indicadores de espacio público (localidad y UPZ) -----------------------
indicador_loc_sel <- indicador_loc |>
dplyr::select(EPE, EPT, EPCC, geometry)
datos <- sf::st_join(datos, indicador_loc_sel, join = sf::st_within)
indicador_upz_sel <- indicador_upz |>
dplyr::select(EPE__m2_ha, geometry, CODIGO_UPZ, NOMBRE) |>
dplyr::rename(
EPE_UPZ   = EPE__m2_ha,
NOMBRE_UPZ = NOMBRE
)
datos <- sf::st_join(datos, indicador_upz_sel, join = sf::st_within)
## 5.2) Luminarias por UPZ -----------------------------------------------------
luminarias_upz_sel <- luminarias_upz |>
dplyr::select(geometry, TOTAL) |>
dplyr::rename(luminarias = TOTAL)
datos <- sf::st_join(datos, luminarias_upz_sel, join = sf::st_within)
## 5.3) Distancias a equipamientos puntuales ----------------------------------
# Bibliotecas
datos <- distneastfeat(datos, bibliotecas, "distnearestlibrary", "puntos")
# Colegios
datos <- distneastfeat(datos, colegios, "distnearestschool", "puntos")
# Museos
datos <- distneastfeat(datos, museo, "distnearestmuseum", "puntos")
# Estaciones de Transmilenio
datos <- distneastfeat(datos, transmi, "distnearesttransmi", "puntos")
## 5.4) Recaudo predial por polígono más cercano --------------------------------
recaudo_predial_sel <- recaudo_predial |>
dplyr::select(geometry, Sum_VALOR_) |>
dplyr::rename(recaudo_predial = Sum_VALOR_)
datos <- sf::st_join(datos, recaudo_predial_sel, join = sf::st_within)
## 5.5) Estrato de la manzana más cercana -------------------------------------
manzanas_estr_sel <- manzanas_estr |>
dplyr::select(geometry, ESTRATO)
datos <- sf::st_join(datos, manzanas_estr_sel, join = sf::st_nearest_feature)
# Se usa vecindad más cercana para asignar estrato
tmp_idx <- sf::st_nearest_feature(datos, manzanas_estr_sel)
datos <- sf::st_join(datos, manzanas_estr_sel, join = sf::st_nearest_feature)
## 5.6) Distancia a paraderos SITP --------------------------------------------
datos <- distneastfeat(datos, sitp, "distnearestsitp", "puntos")
write.csv2(datos, "stores/datos_unides2.csv")
setwd(dirname(dirname(rstudioapi::getActiveDocumentContext()$path)))
library(tidyverse)
data_united <- read.csv2("stores/datos_unides2.csv")
View(data_united)
data_train_final <- data_united %>% filter(property_id %in% data_test$property_id)
setwd(dirname(dirname(rstudioapi::getActiveDocumentContext()$path)))
library(tidyverse)
data_united <- read.csv2("stores/datos_unides2.csv")
data_train <- read.csv("stores/train.csv")
data_test <- read.csv("stores/test.csv")
data_train_final <- data_united %>% filter(property_id %in% data_test$property_id)
setwd(dirname(dirname(rstudioapi::getActiveDocumentContext()$path)))
library(tidyverse)
data_united <- read.csv2("stores/datos_unides2.csv")
data_train <- read.csv("stores/train.csv")
data_test <- read.csv("stores/test.csv")
data_train_final <- data_united %>% filter(property_id %in% data_train$property_id)
data_test_final <- data_united %>% filter(property_id %in% data_test$property_id)
datos <- datos %>% mutate(
lon = st_coordinates(geometry)[,1],
lat = st_coordinates(geometry)[,2]
)
datos <- datos %>% mutate(
lon = st_coordinates(geometry)[,1],
lat = st_coordinates(geometry)[,2]
) %>% select(-geometry)
data_train_final <- datos %>% filter(property_id %in% data_train$property_id)
data_test_final <- datos %>% filter(property_id %in% data_test$property_id)
View(data_train_final)
View(data_test_final)
View(data_train_final)
names(datos)
datos <- datos %>% select(-c(geometry,ESTRATO.x,ESTRATO.y,operation_type,
title,description,text_raw))
names(datos)
datos <- datos %>% select(-c(geometry,ESTRATO.x,ESTRATO.y,operation_type,
title,description,text_raw))
View(datos)
datos <- datos %>% mutate(
lon = st_coordinates(geometry)[,1],
lat = st_coordinates(geometry)[,2]
) %>% select(-geometry)
names(datos)
datos <- datos %>% mutate(
lon = st_coordinates(geometry)[,1],
lat = st_coordinates(geometry)[,2]
)  %>%
st_drop_geometry()
## 7.3) Sacando variables que no usaremos ------------------------------
datos <- datos %>% select(-c(ESTRATO.x,ESTRATO.y,operation_type,
title,description,text_raw))
names(datos)
data_train <- read.csv("stores/train.csv")
data_test <- read.csv("stores/test.csv")
data_train_final <- datos %>% filter(property_id %in% data_train$property_id)
data_test_final <- datos %>% filter(property_id %in% data_test$property_id)
rio::export(datos, "stores/datos_unidos.rds")
write.csv(datos, "stores/datos_unides.csv")
write.csv(data_train_final, "stores/train_final.csv")
write.csv(data_test_final, "stores/test_final.csv")
